(()=>{"use strict";class e{children=[];node;constructor({tag:e="div",className:t="",text:s=""},...n){const i=document.createElement(e);i.className=t,i.textContent=s,this.node=i,n&&this.appendChildren(n)}append(e){this.children.push(e),this.node.append(e.getNode())}appendChildren(e){e.forEach((e=>{this.append(e)}))}getNode(){return this.node}getChildren(){return this.children}setTextContent(e){this.node.textContent=e}setAttribute(e,t){this.node.setAttribute(e,t)}removeAttribute(e){this.node.removeAttribute(e)}addClass(e){this.node.classList.add(e)}removeClass(e){this.node.classList.remove(e)}toggleClass(e){this.node.classList.toggle(e)}hasClass(e){return this.node.classList.contains(e)}addListener(e,t,s=!1){this.node.addEventListener(e,t,s)}removeListener(e,t,s=!1){this.node.removeEventListener(e,t,s)}destroyChildren(){this.children.forEach((e=>{e.destroy()})),this.children.length=0}destroy(){this.destroyChildren(),this.node.remove()}}var t,s,n;!function(e){e.LOGIN="login",e.CHAT="chat",e.ABOUT="about"}(t||(t={})),function(e){e[e.LOGIN_LENGTH=3]="LOGIN_LENGTH",e[e.PASSWROD_LENGTH=6]="PASSWROD_LENGTH"}(s||(s={})),function(e){e.ERROR="ERROR",e.USER_LOGIN="USER_LOGIN",e.USER_LOGOUT="USER_LOGOUT",e.USER_ACTIVE="USER_ACTIVE",e.USER_INACTIVE="USER_INACTIVE",e.USER_EXTERNAL_LOGIN="USER_EXTERNAL_LOGIN",e.USER_EXTERNAL_LOGOUT="USER_EXTERNAL_LOGOUT",e.MSG_SEND="MSG_SEND",e.MSG_FROM_USER="MSG_FROM_USER",e.MSG_DELIVER="MSG_DELIVER",e.MSG_READ="MSG_READ",e.MSG_DELETE="MSG_DELETE",e.MSG_EDIT="MSG_EDIT"}(n||(n={}));class i{callback;handler;static prePath;currentComponent;constructor(t){this.callback=t,this.currentComponent=new e({tag:"div"}),this.handler=()=>this.navigate(null);const s=window.location.pathname.split("/");s.pop(),s.push(""),i.prePath=s.join("/"),window.addEventListener("popstate",this.handler)}navigate(e){"string"==typeof e&&i.setHistory(e);let s=window.location.pathname.split("/").pop();s||(s=null!==sessionStorage.getItem("loginVK")?t.CHAT:t.LOGIN,i.setHistory(s)),s===t.CHAT&&null===sessionStorage.getItem("loginVK")&&(s=t.LOGIN,i.setHistory(s)),s===t.LOGIN&&null!==sessionStorage.getItem("loginVK")&&(s=t.CHAT,i.setHistory(s)),s!==t.CHAT&&s!==t.LOGIN&&s!==t.ABOUT&&(s=null!==sessionStorage.getItem("loginVK")?t.CHAT:t.LOGIN,i.setHistory(s)),this.currentComponent.destroy(),this.callback(s)}disable(){window.removeEventListener("popstate",this.handler)}static setHistory(e){window.history.pushState(null,"",`${i.prePath}${e}`)}}class r{routes;handler;startHandler;bodyHander;isFirstRender;lastRecipient;constructor(e,t){this.routes=e,this.handler=new i(this.urlChangedHandler.bind(this)),this.startHandler=()=>this.handler.navigate(null),window.addEventListener("DOMContentLoaded",this.startHandler),this.bodyHander=t,this.isFirstRender=!0,this.lastRecipient={login:"",online:!0,unread:0}}navigate(e){this.handler.navigate(e)}urlChangedHandler(e){const t=this.routes.find((t=>t.path===e));t&&t.callback()}}class a extends e{onClick=null;type;constructor({className:e,text:t,onClick:s,type:n=""}){super({tag:"button",className:e,text:t}),s&&(this.onClick=s,this.addListener("click",this.onClick)),this.addClass("button"),this.type=n,this.getNode().setAttribute("type",this.type)}destroy(){this.onClick&&this.removeListener("click",this.onClick),super.destroy()}}class o extends e{onKeyUp=null;type;placeholder;constructor({className:e,text:t,onKeyUp:s,type:n="",placeholder:i=""}){super({tag:"input",className:e,text:t}),s&&(this.onKeyUp=s,this.addListener("keyup",this.onKeyUp)),this.addClass("input"),this.type=n,this.placeholder=i,this.getNode().setAttribute("type",this.type),this.getNode().setAttribute("placeholder",this.placeholder)}destroy(){this.onKeyUp&&this.removeListener("keyup",this.onKeyUp),super.destroy()}}class d extends e{href;constructor({className:e,text:t,href:s=""}){super({tag:"a",className:e,text:t}),this.addClass("link"),this.href=s,this.getNode().setAttribute("href",this.href)}}const l=(t,...s)=>new e({tag:"div",className:t},...s),h=(t,s)=>new e({tag:"p",className:t,text:s}),c=(t,s)=>new e({tag:"label",className:t,text:s}),g=(t,s)=>new e({tag:"h2",className:t,text:s}),u=(t,...s)=>new e({tag:"ul",className:t},...s),p=(t,s)=>new e({tag:"li",className:t,text:s}),m=(e,t,s)=>new d({className:e,text:t,href:s}),E=(e,t,s,n)=>new a({className:e,text:t,onClick:s,type:n}),f=(e,t,s,n)=>new o({className:e,onKeyUp:t,type:s,placeholder:n});class C{viewElementCreator;constructor(e={tag:"section",className:"",text:""}){this.viewElementCreator=this.createView(e)}getHtmlElement(){return this.viewElementCreator.getNode()}getComponent(){return this.viewElementCreator}createView(t){const s={tag:t.tag,className:t.className,text:t.text};return this.viewElementCreator=new e(s),this.viewElementCreator}}class _ extends C{constructor(){super({tag:"div",className:"reconnect"}),this.setContent()}setContent(){this.viewElementCreator.appendChildren([l("reconnect-modal",h("reconnect-modal__text","Trying to reconnect..."))])}}class v{connection;isFirstConnection;loginHandler;logoutHandler;getOnlineUsersHandler;getOfflineUsersHandler;externalLoginHandler;externalLogoutHandler;recieveSelfMessageHandler;recieveExternalMessageHandler;getHistoryHandler;messageDeliveredHandler;readSelfMessageHandler;readExternalMessageHandler;deleteSelfMessageHandler;deleteExternalMessageHandler;editSelfMessageHandler;editExternalMessageHandler;enterHandler;reconnectHandler;closeHandler;openHandler;reconnectId;reconnectView;constructor(e,t){this.isFirstConnection=!0,this.connection=new WebSocket(e),this.reconnectId=null,this.reconnectView=null,this.loginHandler=e=>this.getResponse(e,t,"login","LoginError",n.USER_LOGIN,"Login"),this.logoutHandler=e=>this.getResponse(e,t,"logout","LogoutError",n.USER_LOGOUT,"Logout"),this.getOnlineUsersHandler=e=>this.getResponse(e,t,"get_active_users","ActiveContactsError",n.USER_ACTIVE,"ActiveUsers"),this.getOfflineUsersHandler=e=>this.getResponse(e,t,"get_inactive_users","InactiveContactsError",n.USER_INACTIVE,"InactiveUsers"),this.externalLoginHandler=e=>this.getResponse(e,t,null,"",n.USER_EXTERNAL_LOGIN,"ExternalLogin"),this.externalLogoutHandler=e=>this.getResponse(e,t,null,"",n.USER_EXTERNAL_LOGOUT,"ExternalLogout"),this.recieveSelfMessageHandler=e=>this.getResponse(e,t,"msg-send","DialogError",n.MSG_SEND,"ReceiveSelfMessage"),this.recieveExternalMessageHandler=e=>this.getResponse(e,t,null,"",n.MSG_SEND,"ReceiveExternalMessage"),this.getHistoryHandler=e=>this.getResponse(e,t,"get_history","DialogError",n.MSG_FROM_USER,"GetHistory"),this.messageDeliveredHandler=e=>this.getResponse(e,t,null,"",n.MSG_DELIVER,"MessageDelivered"),this.readSelfMessageHandler=e=>this.getResponse(e,t,"msg-read","DialogError",n.MSG_READ,"ReadSelfMessage"),this.readExternalMessageHandler=e=>this.getResponse(e,t,null,"",n.MSG_READ,"ReadExternalMessage"),this.deleteSelfMessageHandler=e=>this.getResponse(e,t,"msg-delete","DialogError",n.MSG_DELETE,"DeleteSelfMessage"),this.deleteExternalMessageHandler=e=>this.getResponse(e,t,null,"",n.MSG_DELETE,"DeleteExternalMessage"),this.editSelfMessageHandler=e=>this.getResponse(e,t,"msg-edit","DialogError",n.MSG_EDIT,"EditSelfMessage"),this.editExternalMessageHandler=e=>this.getResponse(e,t,null,"",n.MSG_EDIT,"EditExternalMessage"),this.enterHandler=()=>this.reEnter(t),this.reconnectHandler=()=>this.reconnect(e),this.closeHandler=()=>{this.isFirstConnection&&(this.isFirstConnection=!1,this.connection.addEventListener("close",this.reconnectHandler)),this.connection.close()},this.openHandler=()=>this.open(),this.addListeners()}reEnter(e){this.connection.removeEventListener("Login",this.enterHandler),e.isFirstRender=!1,e.navigate(t.CHAT)}reconnect(e){this.reconnectView=new _,document.body.append(this.reconnectView.getHtmlElement()),this.reconnectId=setInterval((()=>{this.connection=new WebSocket(e),this.addListeners()}),4e3)}sendRequest(e){this.connection.send(e)}addListeners(){this.connection.addEventListener("message",this.loginHandler),this.connection.addEventListener("message",this.logoutHandler),this.connection.addEventListener("message",this.getOnlineUsersHandler),this.connection.addEventListener("message",this.getOfflineUsersHandler),this.connection.addEventListener("message",this.externalLoginHandler),this.connection.addEventListener("message",this.externalLogoutHandler),this.connection.addEventListener("message",this.recieveSelfMessageHandler),this.connection.addEventListener("message",this.recieveExternalMessageHandler),this.connection.addEventListener("message",this.getHistoryHandler),this.connection.addEventListener("message",this.messageDeliveredHandler),this.connection.addEventListener("message",this.readSelfMessageHandler),this.connection.addEventListener("message",this.readExternalMessageHandler),this.connection.addEventListener("message",this.deleteSelfMessageHandler),this.connection.addEventListener("message",this.deleteExternalMessageHandler),this.connection.addEventListener("message",this.editSelfMessageHandler),this.connection.addEventListener("message",this.editExternalMessageHandler),this.connection.addEventListener("open",this.openHandler),this.connection.addEventListener("error",this.closeHandler)}open(){if(this.isFirstConnection=!1,this.connection.addEventListener("close",this.reconnectHandler),this.reconnectId&&(this.reconnectView&&this.reconnectView.getComponent().destroy(),clearInterval(this.reconnectId),null!==sessionStorage.getItem("loginVK"))){const e=sessionStorage.getItem("loginVK");if(e){const t=JSON.parse(e),s={id:"login",type:n.USER_LOGIN,payload:{user:t}};this.sendRequest(JSON.stringify(s)),this.connection.addEventListener("Login",this.enterHandler)}}}getResponse(e,t,s,i,r,a){const o=t.handler.currentComponent.getNode();if(!(e instanceof MessageEvent))return;const d=JSON.parse(e.data);if(d.id===s&&(null!==s&&d.type===n.ERROR&&"error"in d.payload&&o.dispatchEvent(new CustomEvent(i,{detail:d.payload.error,bubbles:!0})),d.type===r)){let e=null;"users"in d.payload&&(e=d.payload.users),"user"in d.payload&&(e=d.payload.user),"message"in d.payload&&(e=d.payload.message),"messages"in d.payload&&(e=d.payload.messages),o.dispatchEvent(new CustomEvent(a,{detail:e,bubbles:!0})),r===n.USER_LOGIN&&this.connection.dispatchEvent(new CustomEvent(a,{bubbles:!0}))}}}class H extends C{backHandler;constructor(e){super({tag:"main",className:"about"}),e.handler.currentComponent=this.getComponent(),this.backHandler=()=>H.back(e),this.setContent()}setContent(){this.viewElementCreator.appendChildren([g("about__title","Fun Chat"),h("about__description","Application for chatting developed in RSSchool JS/FE 2023Q4"),m("about__author","author Vadim Kolymbet","https://github.com/VadimKol"),E("about__back","Get back",this.backHandler,"button")])}static back(e){const s=null!==sessionStorage.getItem("loginVK")?t.CHAT:t.LOGIN;e.navigate(s)}}class L extends C{getInfoHandler;exitBtnHandler;exitHandler;errorHandler;constructor(e,t,s,n){super({tag:"header",className:"header"}),t.handler.currentComponent=e,this.getInfoHandler=()=>L.getInfo(t),this.exitBtnHandler=()=>L.exitBtn(s,n),this.setContent(n),this.exitHandler=()=>L.exit(t),this.errorHandler=e=>L.showLogoutError(e,n),e.getNode().addEventListener("LogoutError",this.errorHandler),e.getNode().addEventListener("Logout",this.exitHandler)}setContent(e){const t=sessionStorage.getItem("loginVK");t&&this.viewElementCreator.appendChildren([l("header-wrapper",c("header-wrapper__user",`${JSON.parse(t).login}`),g("header-wrapper__title","Fun Chat")),l("header-buttons",E("header-buttons__info","Info",this.getInfoHandler,"button"),E("header-buttons__exit","Exit",this.exitBtnHandler,"button")),e])}static getInfo(e){e.navigate(t.ABOUT)}static exitBtn(e,t){t.removeClass("modal__error_show");const s=sessionStorage.getItem("loginVK");if(!s)return;const i={id:"logout",type:n.USER_LOGOUT,payload:{user:JSON.parse(s)}};e.sendRequest(JSON.stringify(i))}static exit(e){e.lastRecipient={login:"",online:!0,unread:0},sessionStorage.removeItem("loginVK"),e.navigate(t.LOGIN)}static showLogoutError(e,t){e instanceof CustomEvent&&(t.setTextContent(e.detail),t.addClass("modal__error_show"))}}class S extends C{requestToRefreshContactsHandler;errorHandler;addUsersHandler;updateUserStatusHandler;users;userList;constructor(e,t,s){super({tag:"aside",className:"contacts"}),this.users=[],this.requestToRefreshContactsHandler=()=>this.requestToRefreshContacts(e,t),this.updateUserStatusHandler=e=>this.updateUserStatus(e),this.addUsersHandler=e=>this.addUsers(e,t),this.errorHandler=e=>S.showError(e,s);const n=t;this.userList=u("contacts-users"),this.setContent(),t.isFirstRender||this.requestToRefreshContacts(e,t),e.connection.addEventListener("open",this.requestToRefreshContactsHandler),n.handler.currentComponent.getNode().addEventListener("ActiveContactsError",this.errorHandler),n.handler.currentComponent.getNode().addEventListener("InactiveContactsError",this.errorHandler),n.handler.currentComponent.getNode().addEventListener("ActiveUsers",this.addUsersHandler),n.handler.currentComponent.getNode().addEventListener("InactiveUsers",this.addUsersHandler),n.handler.currentComponent.getNode().addEventListener("ExternalLogin",this.updateUserStatusHandler),n.handler.currentComponent.getNode().addEventListener("ExternalLogout",this.updateUserStatusHandler),this.userList.addListener("click",S.clickOnUser.bind(this))}setContent(){this.viewElementCreator.appendChildren([f("contacts__search",this.searchUser.bind(this),"text","Search..."),this.userList])}searchUser(e){if(!(e instanceof KeyboardEvent))return;const{target:t}=e;if(!(t instanceof HTMLInputElement))return;const s=t.value.length>0?this.users.filter((e=>e.login.includes(t.value))):this.users;this.showUsers(s)}requestToRefreshContacts(e,t){t.isFirstRender=!1,e.connection.removeEventListener("open",this.requestToRefreshContactsHandler);const s={id:"get_active_users",type:n.USER_ACTIVE,payload:null},i={id:"get_inactive_users",type:n.USER_INACTIVE,payload:null};e.sendRequest(JSON.stringify(s)),e.sendRequest(JSON.stringify(i))}updateUserStatus(e){if(!(e instanceof CustomEvent))return;let t=!0;const s=e.detail;this.users.forEach((e=>{e.login===s.login&&(e.online=s.isLogined,t=!1)})),t&&this.users.push({login:s.login,online:s.isLogined,unread:0}),this.showUsers(this.users)}addUsers(e,t){if(!(e instanceof CustomEvent))return;const s="ActiveUsers"===e.type;e.detail.forEach((e=>{this.users.push({login:e.login,online:s,unread:0})}));const n=sessionStorage.getItem("loginVK");if(!n)return;const i=JSON.parse(n).login;this.users=this.users.filter((e=>e.login!==i)),s||t.handler.currentComponent.getNode().dispatchEvent(new CustomEvent("GetHistoryUsers",{detail:this.users,bubbles:!0})),this.showUsers(this.users)}showUsers(e){this.userList.destroyChildren(),e.sort(((e,t)=>e.online&&!t.online?-2:!e.online&&t.online?2:e.login>t.login?1:e.login<t.login?-1:0)),e.forEach((e=>{const t=p("contacts-users__user",e.login);t.addClass("contacts-users__user_"+(e.online?"online":"offline")),e.unread>0&&t.addClass("contacts-users__user_unread"),t.setAttribute("data-after",`${e.unread}`),this.userList.append(t)}))}static showError(e,t){e instanceof CustomEvent&&(t.setTextContent(e.detail),t.addClass("modal__error_show"))}static clickOnUser(e){const{target:t}=e;if(!(t instanceof HTMLLIElement))return;const s=t.textContent;if(!s)return;const n={login:s,online:t.classList.contains("contacts-users__user_online"),unread:Number(t.getAttribute("data-after"))};t.dispatchEvent(new CustomEvent("Chat",{detail:n,bubbles:!0}))}}class M{chatHandler;constructor(e,t,s,n,i,r,a,o){this.chatHandler=d=>M.chat(d,e,t,s,n,i,r,a,o)}static chat(e,t,s,n,i,r,a,o,d){if(!(e instanceof CustomEvent))return;const l=e.detail,h=s.getChildren()[0];h&&h.addClass("dialog-recipient_show"),i.setTextContent(`${l.login}`),r.setTextContent(l.online?"Online":"Offline"),l.online?r.removeClass("dialog-recipient__status_offline"):r.addClass("dialog-recipient__status_offline"),t.lastRecipient=l,a.addClass("dialog-msg-box__msg_show");const c=n.find((e=>e.login===l.login));c?(M.showMessages(c,t,o),o.removeClass("dialog-content_first")):(o.destroyChildren(),o.addClass("dialog-content_first")),M.scrollToMsg(c,o),o.removeClass("dialog-content_zero"),d()}static showMessages(e,t,s){if(e.login!==t.lastRecipient.login)return;s.destroyChildren();const n=sessionStorage.getItem("loginVK");if(!n)return;const i=JSON.parse(n).login,r=function(e,t){let s="";return e.some((e=>e.from!==t&&!e.status.isReaded&&(s=e.id,!0))),s}(e.messages,i);e.messages.forEach((e=>{let t="",n="";e.status.isEdited&&(n="edited"),e.status.isDelivered?(t="delivered",e.status.isReaded&&(t="readed")):t="sended";const a=h("msg__status",`${t}`),o=h("msg__edit",`${n}`),d=l("msg-footer",o,a),c=l("msg",l("msg-header",h("msg-header__who",`${e.from===i?"you":e.from}`),h("msg-header__date",`${function(e){const t=e.getDate()<10?`0${e.getDate()}`:`${e.getDate()}`,s=e.getMonth()+1<10?`0${e.getMonth()+1}`:`${e.getMonth()+1}`,n=e.getFullYear()<10?`0${e.getFullYear()}`:`${e.getFullYear()}`,i=e.getHours(),r=e.getMinutes(),a=e.getSeconds();return`${t}.${s}.${n}, ${i<10?`0${i}`:i}:${r<10?`0${r}`:r}:${a<10?`0${a}`:a}`}(new Date(e.datetime))}`)),h("msg__text",`${e.text}`),d);e.from===i&&(a.addClass("msg__status_show"),c.addClass("msg_self"),d.addClass("msg-footer_self"),""!==n&&d.addClass("msg-footer_edit")),""!==n&&o.addClass("msg__edit_show"),c.setAttribute("id",`${e.id}`),r===e.id&&c.addClass("msg_divide"),s.append(c)}))}static updateMessages(e,t,s,n){if(e.login!==t.lastRecipient.login)return;const i=n.getChildren();e.messages.forEach((e=>{i.forEach((t=>{const n=t.getNode().getAttribute("id"),i=t.getChildren()[2],r=t.getChildren()[1];if(!i)return;if(!r)return;const a=i.getNode().lastElementChild,o=i.getNode().firstElementChild;a&&n&&n===e.id&&(e.status.isEdited&&o&&(o.textContent="edited",o.classList.add("msg__edit_show"),t.hasClass("msg_self")&&i.addClass("msg-footer_edit"),r.getNode().textContent=e.text),e.status.isDelivered?(a.textContent="delivered",e.status.isReaded&&(a.textContent="readed")):a.textContent="sended","ReadSelfMessage"===s.type&&t.removeClass("msg_divide"))}))}))}static scrollToMsg(e,t){const s=sessionStorage.getItem("loginVK");if(!s)return;const n=JSON.parse(s).login,i=t.getChildren(),r=function(e,t){let s="";if(e.length>0)if(e.some((e=>e.from!==t&&!e.status.isReaded))){const n=e.find((e=>e.from!==t&&!e.status.isReaded));n&&(s=n.id)}else{const t=e.pop();t&&(s=t.id)}return s}(e?[...e.messages]:[],n);i.forEach((e=>{e.getNode().id===r&&e.getNode().scrollIntoView({behavior:"smooth",block:"center"})}))}}class y{refreshUserStatusHandler;addSelfMessageHandler;addExternalMessageHandler;loadHistoryHandler;updateMessageStatusHandler;deleteMessageHandler;constructor(e,t,s,n,i,r,a,o){this.refreshUserStatusHandler=e=>y.refreshUserStatus(e,n,i,r,a),this.addSelfMessageHandler=e=>y.addSelfMessage(e,n,s,r,a,o),this.addExternalMessageHandler=s=>y.addExternalMessage(s,n,e,t,r,a),this.loadHistoryHandler=s=>y.loadHistory(s,n,t,e,r,a),this.updateMessageStatusHandler=s=>y.updateMessageStatus(s,n,e,t,r,a),this.deleteMessageHandler=s=>y.deleteMessage(s,n,e,t,r,a)}static refreshUserStatus(e,t,s,n,i){if(!(e instanceof CustomEvent))return;const r=e.detail;t.lastRecipient.login===r.login&&(s.setTextContent(r.isLogined?"Online":"Offline"),t.lastRecipient.online=r.isLogined,r.isLogined?s.removeClass("dialog-recipient__status_offline"):s.addClass("dialog-recipient__status_offline"),n.some((e=>e.login===t.lastRecipient.login))||i.addClass("dialog-content_first"))}static addSelfMessage(e,t,s,n,i,r){if(!(e instanceof CustomEvent))return;const a=e.detail;let o=n.find((e=>e.login===t.lastRecipient.login));o?o.messages.push(a):(o={login:t.lastRecipient.login,messages:[],unread:0},o.messages.push(a),n.push(o)),M.showMessages(o,t,i),r(t,s),M.scrollToMsg(o,i),i.removeClass("dialog-content_first")}static addExternalMessage(e,t,s,n,i,r){if(!(e instanceof CustomEvent))return;const a=e.detail,o=sessionStorage.getItem("loginVK");if(!o)return;const d=JSON.parse(o).login,l=a.to===d?a.from:a.to;let h=i.find((e=>e.login===l));h?(h.messages.push(a),h.unread+=1):(h={login:l,messages:[],unread:1},h.messages.push(a),i.push(h)),n.users.forEach((e=>{h&&e.login===h.login&&(e.unread=h.unread)})),M.showMessages(h,t,r),y.showUnread(h,s),M.scrollToMsg(h,r),r.removeClass("dialog-content_first")}static loadHistory(e,t,s,n,i,r){if(!(e instanceof CustomEvent))return;const a=sessionStorage.getItem("loginVK");if(!a)return;const o=JSON.parse(a).login,d=e.detail;if(d.length>0){const e=d[0];if(!e)return;const a=e.to===o?e.from:e.to;let l=0;d.forEach((e=>{e.to!==o||e.status.isReaded||(l+=1)}));const h={login:a,messages:[...d],unread:l};s.users.forEach((e=>{e.login===h.login&&(e.unread=h.unread)})),i.push(h),r.removeClass("dialog-content_first"),M.showMessages(h,t,r),y.showUnread(h,n),M.scrollToMsg(h,r)}""===t.lastRecipient.login||i.some((e=>e.login===t.lastRecipient.login))||r.addClass("dialog-content_first")}static updateMessageStatus(e,t,s,n,i,r){if(!(e instanceof CustomEvent))return;const a=e.detail,o=i.find((e=>e.messages.find((e=>e.id===a.id))));o&&(o.messages.forEach((e=>{if(e.id===a.id){const t=e;if("isDelivered"in a.status&&(t.status.isDelivered=a.status.isDelivered),"isReaded"in a.status&&(t.status.isReaded=a.status.isReaded),"isEdited"in a.status){t.status.isEdited=a.status.isEdited;const e=a?.text;e&&(t.text=e)}}})),M.updateMessages(o,t,e,r),"ReadSelfMessage"===e.type&&(o.unread=0,n.users.forEach((e=>{o&&e.login===o.login&&(e.unread=o.unread)})),y.showUnread(o,s),M.scrollToMsg(o,r)))}static deleteMessage(e,t,s,n,i,r){if(!(e instanceof CustomEvent))return;const a=e.detail,o=i.find((e=>e.messages.find((e=>e.id===a.id))));o&&(o.messages.forEach((e=>{if(e.id===a.id){const t=e;"isDeleted"in a.status&&(e.status.isReaded||(o.unread-=1),t.id="")}})),o.messages=o.messages.filter((e=>""!==e.id)),M.showMessages(o,t,r),"DeleteExternalMessage"===e.type&&(n.users.forEach((e=>{o&&e.login===o.login&&(e.unread=o.unread)})),y.showUnread(o,s)))}static showUnread(e,t){const s=t.getChildren()[0];if(!s)return;const n=s.getChildren()[1];n&&n.getChildren().forEach((t=>{t.getNode().textContent===e.login&&(t.setAttribute("data-after",`${e.unread}`),e.unread>0?t.addClass("contacts-users__user_unread"):t.removeClass("contacts-users__user_unread"))}))}}class R extends C{messageInput;sendBtn;editBtn;dialogContent;recipientName;recipientStatus;sendMsgHandler;errorHandler;keyEnterHandler;readMsgHandler;menuMsgRequestHandler;requestGetHistoryHandler;messages;menu;edited;eventController;controller;constructor(e,t,s,n,i){if(super({tag:"div",className:"dialog"}),this.messages=[],this.menu=null,this.edited="",this.sendMsgHandler=()=>this.sendMsg(s,t),this.keyEnterHandler=e=>this.keyEnter(e,s,t),this.messageInput=f("dialog-msg-box__msg",this.keyEnterHandler,"text","Message..."),this.sendBtn=E("send","Send",this.sendMsgHandler,"button"),this.editBtn=E("edit","X",this.endEditMsg.bind(this),"button"),this.sendBtn.addClass("disabled"),this.errorHandler=e=>function(e,t){e instanceof CustomEvent&&(t.setTextContent(e.detail),t.addClass("modal__error_show"))}(e,n),this.dialogContent=l("dialog-content"),this.recipientName=c("dialog-recipient__name",`${s.lastRecipient.login}`),this.recipientStatus=c("dialog-recipient__status",s.lastRecipient.online?"Online":"Offline"),this.controller=new M(s,this.getComponent(),this.messages,this.recipientName,this.recipientStatus,this.messageInput,this.dialogContent,this.endEditMsg.bind(this)),this.eventController=new y(e,i,t,s,this.recipientStatus,this.messages,this.dialogContent,this.readMsg.bind(this)),s.lastRecipient.online?this.recipientStatus.removeClass("dialog-recipient__status_offline"):this.recipientStatus.addClass("dialog-recipient__status_offline"),this.setContent(),""!==s.lastRecipient.login){const e=this.getComponent().getChildren()[0];e&&e.addClass("dialog-recipient_show"),this.messageInput.addClass("dialog-msg-box__msg_show")}else this.dialogContent.addClass("dialog-content_zero");this.readMsgHandler=()=>this.readMsg(s,t),this.menuMsgRequestHandler=e=>this.menuMsgRequest(e,t),this.requestGetHistoryHandler=e=>R.requestGetHistory(e,t),e.getNode().addEventListener("Chat",this.controller.chatHandler);const r=s.handler.currentComponent.getNode();r.addEventListener("GetHistoryUsers",this.requestGetHistoryHandler),r.addEventListener("ExternalLogin",this.eventController.refreshUserStatusHandler),r.addEventListener("ExternalLogout",this.eventController.refreshUserStatusHandler),r.addEventListener("ReceiveSelfMessage",this.eventController.addSelfMessageHandler),r.addEventListener("ReceiveExternalMessage",this.eventController.addExternalMessageHandler),r.addEventListener("GetHistory",this.eventController.loadHistoryHandler),r.addEventListener("MessageDelivered",this.eventController.updateMessageStatusHandler),r.addEventListener("ReadSelfMessage",this.eventController.updateMessageStatusHandler),r.addEventListener("ReadExternalMessage",this.eventController.updateMessageStatusHandler),r.addEventListener("DeleteSelfMessage",this.eventController.deleteMessageHandler),r.addEventListener("DeleteExternalMessage",this.eventController.deleteMessageHandler),r.addEventListener("EditSelfMessage",this.eventController.updateMessageStatusHandler),r.addEventListener("EditExternalMessage",this.eventController.updateMessageStatusHandler),r.addEventListener("DialogError",this.errorHandler),this.dialogContent.getNode().addEventListener("click",this.readMsgHandler),this.dialogContent.getNode().addEventListener("wheel",this.readMsgHandler),this.dialogContent.getNode().addEventListener("contextmenu",this.createMenu.bind(this)),r.addEventListener("click",this.closeMenu.bind(this))}setContent(){this.viewElementCreator.appendChildren([l("dialog-recipient",this.recipientName,this.recipientStatus),this.dialogContent,l("dialog-msg-box",l("wrap",this.messageInput,this.editBtn),this.sendBtn)])}keyEnter(e,t,s){if(!(e instanceof KeyboardEvent))return;const{target:n}=e;n instanceof HTMLInputElement&&(n.value.length>0?this.sendBtn.removeClass("disabled"):this.sendBtn.addClass("disabled"),"Enter"!==e.key||this.sendBtn.hasClass("disabled")||this.sendMsg(t,s))}sendMsg(e,t){const s=this.messageInput.getNode();if(!(s instanceof HTMLInputElement))return;const i=s.value,r=e.lastRecipient.login;if(s.value="",this.sendBtn.addClass("disabled"),""===this.edited){const e={id:"msg-send",type:n.MSG_SEND,payload:{message:{to:r,text:i}}};t.sendRequest(JSON.stringify(e))}else{const e={id:"msg-edit",type:n.MSG_EDIT,payload:{message:{id:this.edited,text:i}}};t.sendRequest(JSON.stringify(e)),this.endEditMsg()}}endEditMsg(){const e=this.messageInput.getNode();e instanceof HTMLInputElement&&(e.value="",this.edited="",this.editBtn.removeClass("edit_show"),this.sendBtn.addClass("disabled"))}readMsg(e,t){if(""===e.lastRecipient.login)return;const s=this.messages.find((t=>t.login===e.lastRecipient.login));if(!s)return;const i=sessionStorage.getItem("loginVK");if(!i)return;const r=JSON.parse(i).login;s.messages.filter((e=>!e.status.isReaded&&e.to===r)).forEach((e=>{const s={id:"msg-read",type:n.MSG_READ,payload:{message:{id:e.id}}};t.sendRequest(JSON.stringify(s))}))}createMenu(e){const{target:t}=e;if(!(t instanceof HTMLElement))return;const s=t.parentElement;if(!(s instanceof HTMLElement))return;const n=s.parentElement;if(!(n instanceof HTMLElement))return;let i=null;t.classList.contains("msg_self")&&(i=t),s.classList.contains("msg_self")&&(i=s),n.classList.contains("msg_self")&&(i=n),i&&(e.preventDefault(),this.menu&&(this.menu.destroy(),this.menu=null),this.menu=u("msg-menu",p("msg-menu__delete","Delete"),p("msg-menu__edit","Edit")),i.append(this.menu.getNode()),this.menu.addListener("click",this.menuMsgRequestHandler))}menuMsgRequest(e,t){const{target:s}=e;if(!(s instanceof HTMLElement))return;const i=s.parentElement;if(!(i instanceof HTMLElement))return;const r=i.parentElement;if(r instanceof HTMLElement&&(s.classList.contains("msg-menu__delete")||s.classList.contains("msg-menu__edit"))){if(this.menu&&(this.menu.destroy(),this.menu=null),s.classList.contains("msg-menu__delete")){const e={id:"msg-delete",type:n.MSG_DELETE,payload:{message:{id:r.id}}};t.sendRequest(JSON.stringify(e)),this.endEditMsg()}if(s.classList.contains("msg-menu__edit")){const e=this.messageInput.getNode();if(!(e instanceof HTMLInputElement))return;const t=r.children[1];if(!t)return;const s=t.textContent;if(!s)return;e.value=s,this.edited=r.id,this.editBtn.addClass("edit_show"),this.sendBtn.removeClass("disabled")}}}closeMenu(e){const{target:t}=e;t instanceof HTMLElement&&(t.classList.contains("msg-menu__delete")||t.classList.contains("msg-menu__edit")||this.menu&&(this.menu.destroy(),this.menu=null))}static requestGetHistory(e,t){e instanceof CustomEvent&&e.detail.forEach((e=>{const s={id:"get_history",type:n.MSG_FROM_USER,payload:{user:{login:e.login}}};t.sendRequest(JSON.stringify(s))}))}}class w extends C{constructor(e,t,s){super({tag:"section",className:"content"}),this.setContent(e,t,s)}setContent(e,t,s){const n=new S(e,t,s),i=new R(this.getComponent(),e,t,s,n);this.viewElementCreator.appendChildren([n.getComponent(),i.getComponent()])}}class N extends C{constructor(){super({tag:"footer",className:"footer"}),this.setContent()}setContent(){this.viewElementCreator.appendChildren([l("footer__logo"),c("footer__school","RSSchool"),m("footer__author","Vadim Kolymbet","https://github.com/VadimKol"),c("footer__year","2024")])}}class I extends C{modalError;constructor(e,t){super({tag:"main",className:"chat"}),this.modalError=c("modal__error",""),this.setContent(e,t)}setContent(e,t){const s=new L(this.getComponent(),e,t,this.modalError),n=new w(t,e,this.modalError),i=new N;this.viewElementCreator.appendChildren([s.getComponent(),n.getComponent(),i.getComponent()])}}class x extends C{loginInput;passInput;enterButton;loginError;passwordError;serverError;enterBtnHandler;enterKeyHandler;enterHandler;getInfoHandler;user;constructor(e,t){super({tag:"form",className:"login-form"}),this.loginInput=f("name-group__login",this.validateInput.bind(this),"text","Login"),this.passInput=f("password-group__password",this.validateInput.bind(this),"password","Password"),this.loginError=c("login__error",""),this.passwordError=c("password__error",""),this.serverError=c("server__error",""),e.handler.currentComponent=this.getComponent(),this.enterBtnHandler=()=>this.enterBtn(t),this.enterButton=E("login-form__submit","Enter",this.enterBtnHandler,"button"),this.enterButton.addClass("disabled"),this.getInfoHandler=()=>this.getInfo(e),this.setContent(),this.enterKeyHandler=e=>this.enterKey(e,t),this.enterHandler=()=>this.enter(e),this.user=null,document.addEventListener("keyup",this.enterKeyHandler),document.body.removeEventListener("LoginError",e.bodyHander),this.getComponent().getNode().addEventListener("LoginError",this.showLoginError.bind(this)),this.getComponent().getNode().addEventListener("Login",this.enterHandler)}setContent(){this.viewElementCreator.appendChildren([l("login-group",l("name-group",c("name-group__name-field","Login"),this.loginInput),this.loginError,l("password-group",c("password-group__pass-field","Password"),this.passInput),this.passwordError),this.enterButton,E("login-form__info","Info",this.getInfoHandler,"button"),this.serverError])}enterBtn(e){const t=this.loginInput.getNode(),s=this.passInput.getNode();if(!(t instanceof HTMLInputElement&&s instanceof HTMLInputElement))return;if(!t.classList.contains("input_valid")||!s.classList.contains("input_valid"))return;this.user={login:t.value,password:s.value};const i={id:"login",type:n.USER_LOGIN,payload:{user:this.user}};e.sendRequest(JSON.stringify(i))}getInfo(e){document.removeEventListener("keyup",this.enterKeyHandler),e.navigate(t.ABOUT)}validateInput(e){const{target:t}=e;if(!(t instanceof HTMLInputElement))return;const n="Password"===t.placeholder?s.PASSWROD_LENGTH:s.LOGIN_LENGTH;this.isValid(t.value,t.placeholder,n)?(t.classList.add("input_valid"),this.hideValidationError(t.placeholder)):t.classList.remove("input_valid"),this.loginInput.hasClass("input_valid")&&this.passInput.hasClass("input_valid")?this.enterButton.removeClass("disabled"):this.enterButton.addClass("disabled")}isValid(e,t,s){let n=!1;return e.length<s?this.showValidationError(`${t} should be min ${s} letters`,t):/^[A-Za-z0-9]+$/.exec(e)?"Password"===t&&-1===e.search(/[A-Z]/g)?this.showValidationError(`${t} must have capital letter`,t):n=!0:this.showValidationError(`${t} must have only English letters or digits`,t),n}showValidationError(e,t){"Password"===t?(this.passwordError.addClass("password__error_show"),this.passwordError.setTextContent(e)):(this.loginError.addClass("login__error_show"),this.loginError.setTextContent(e))}hideValidationError(e){"Password"===e?this.passwordError.removeClass("password__error_show"):this.loginError.removeClass("login__error_show")}enterKey(e,t){if(!(e instanceof KeyboardEvent))return;const{target:s}=e;if(!(s instanceof Element))return;const n=s.firstElementChild;(n instanceof Element&&n.classList.contains("login-form")||s instanceof HTMLInputElement&&("Password"===s.placeholder||"Login"===s.placeholder))&&"Enter"===e.key&&this.enterBtn(t)}showLoginError(e){e instanceof CustomEvent&&(this.serverError.setTextContent(e.detail),this.serverError.addClass("server__error_show"))}enter(e){document.removeEventListener("keyup",this.enterKeyHandler),sessionStorage.setItem("loginVK",JSON.stringify(this.user)),e.isFirstRender=!1,e.navigate(t.CHAT)}}(new class{router;serverConnection;constructor(){document.body.classList.add("body"),this.preLoginError=this.preLoginError.bind(this),this.router=new r(this.createRoutes(),this.preLoginError),this.serverConnection=new v("wss://fun-chat-vadimkol.amvera.io",this.router),this.preOpen=this.preOpen.bind(this)}start(){null!==sessionStorage.getItem("loginVK")&&(document.body.addEventListener("LoginError",this.preLoginError),this.serverConnection.connection.addEventListener("open",this.preOpen))}preOpen(){this.serverConnection.connection.removeEventListener("open",this.preOpen);const e=sessionStorage.getItem("loginVK");if(!e)return;const t={id:"login",type:n.USER_LOGIN,payload:{user:JSON.parse(e)}};this.serverConnection.sendRequest(JSON.stringify(t))}preLoginError(){sessionStorage.removeItem("loginVK"),this.router.navigate(t.LOGIN)}createRoutes(){return[{path:`${t.LOGIN}`,callback:()=>{document.body.append(new x(this.router,this.serverConnection).getHtmlElement())}},{path:`${t.CHAT}`,callback:()=>{document.body.append(new I(this.router,this.serverConnection).getHtmlElement())}},{path:`${t.ABOUT}`,callback:()=>{document.body.append(new H(this.router).getHtmlElement())}}]}}).start()})();